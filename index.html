<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ¬ãƒ¼ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè¦³è¦§å°‚ç”¨ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .crown {
      animation: shine 2s infinite;
    }
    @keyframes shine {
      0%, 100% { filter: drop-shadow(0 0 5px gold); }
      50% { filter: drop-shadow(0 0 15px gold); }
    }
    .starburst {
      animation: starpop 1s ease-out forwards;
    }
    @keyframes starpop {
      from { transform: scale(0.5); opacity: 0; }
      to { transform: scale(1.2); opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">ğŸ† ãƒ¬ãƒ¼ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
  <div class="overflow-x-auto">
    <table class="table-auto w-full bg-white rounded shadow text-center">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2">é †ä½</th>
          <th class="p-2">åå‰</th>
          <th class="p-2">åˆè¨ˆãƒ¬ãƒ¼ãƒˆ</th>
          <th class="p-2">å‹ç‡</th>
          <th class="p-2">å‰å›é †ä½</th>
          <th class="p-2">ä»Šå›é †ä½</th>
          <th class="p-2">å¤‰å‹•</th>
          <th class="p-2">ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆ</th>
          <th class="p-2">ç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹</th>
          <th class="p-2">1ä½ã¨ã®å·®</th>
          <th class="p-2">ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ç§°å·</th>
        </tr>
      </thead>
      <tbody id="rankingTable"></tbody>
    </table>
  </div>

  <script>
    let previousData = [];

    // å‹ç‡ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå°æ•°ç‚¹ä»¥ä¸‹2æ¡ï¼…è¡¨ç¤ºï¼‰
    function formatWinRate(player) {
      if (!player.wins || !player.totalGames || player.totalGames === 0) return "-";
      return ((player.wins / player.totalGames) * 100).toFixed(2) + "%";
    }

    // ç§°å·å–å¾—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ä¾‹ã€‚å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µï¼‰
    function getTitle(player) {
      if (player.title) return player.title;
      if (player.rate >= 80) return "ç‹è€…";
      if (player.rate < 40) return "ãƒ«ãƒ¼ã‚­ãƒ¼";
      if ((player.consecutiveWins || 0) >= 3) return "å‹ã¡é€ƒã’";
      if ((player.matchesPlayed || 0) >= 10) return "çš†å‹¤ç‹";
      return "";
    }

    function renderRanking(players) {
      const tbody = document.getElementById("rankingTable");
      tbody.innerHTML = "";

      // 1ä½ãƒ¬ãƒ¼ãƒˆå–å¾—
      const topRate = players.length > 0 ? players.reduce((max, p) => Math.max(max, p.rate || 0), 0) : 0;

      // ãƒ©ãƒ³ã‚¯é †ã«ã‚½ãƒ¼ãƒˆ
      const sorted = [...players].sort((a, b) => (a.currentRank || 9999) - (b.currentRank || 9999));

      sorted.forEach((p, index) => {
        const isFirst = index === 0;
        // é †ä½å¤‰å‹• = å‰å›é †ä½ - ä»Šå›é †ä½ï¼ˆãƒ—ãƒ©ã‚¹ãªã‚‰é †ä½ã‚¢ãƒƒãƒ—ï¼‰
        const rankDiff = (p.prevRank !== undefined && p.currentRank !== undefined) ? (p.prevRank - p.currentRank) : 0;
        const rankDiffText = rankDiff > 0 ? `â†‘${rankDiff}` : (rankDiff < 0 ? `â†“${-rankDiff}` : "-");
        const rankDiffClass = rankDiff > 0 ? "text-green-600" : (rankDiff < 0 ? "text-red-500" : "text-gray-400");

        // 1ä½ã¨ã®å·®
        const diffFromTop = (topRate - (p.rate || 0)) || 0;

        // ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚„ç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹ã¯ 0 ãªã‚‰ç©ºç™½è¡¨ç¤º
        const bonusPoints = p.bonusPoints || 0;
        const specialBonus = p.specialBonus || 0;

        const tr = document.createElement("tr");
        tr.className = `${isFirst ? "bg-yellow-100 font-bold" : ""}`;

        tr.innerHTML = `
          <td class="p-2">${p.currentRank || index + 1}</td>
          <td class="p-2 flex items-center justify-center gap-1">
            ${isFirst ? '<span class="crown">ğŸ‘‘</span>' : ''}
            <span>${p.name || "åç„¡ã—"}</span>
            ${p.firstTimeTop ? '<span class="text-yellow-400 starburst">â­</span>' : ''}
          </td>
          <td class="p-2">${p.rate || 0}</td>
          <td class="p-2">${formatWinRate(p)}</td>
          <td class="p-2">${p.prevRank || "-"}</td>
          <td class="p-2">${p.currentRank || "-"}</td>
          <td class="p-2 ${rankDiffClass}">${rankDiffText}</td>
          <td class="p-2">${bonusPoints > 0 ? `+${bonusPoints}` : (bonusPoints < 0 ? bonusPoints : "-")}</td>
          <td class="p-2">${specialBonus > 0 ? `+${specialBonus}` : (specialBonus < 0 ? specialBonus : "-")}</td>
          <td class="p-2">${diffFromTop}</td>
          <td class="p-2">${getTitle(p)} ${p.comment || ""}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    // 1. postMessage ã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
    window.addEventListener("message", (event) => {
      if (!Array.isArray(event.data)) return;
      renderRanking(event.data);
      previousData = event.data;
    });

    // 2. fallback: localStorage polling
    setInterval(() => {
      const raw = localStorage.getItem("players");
      if (!raw) return;
      const data = JSON.parse(raw);
      if (JSON.stringify(data) !== JSON.stringify(previousData)) {
        renderRanking(data);
        previousData = data;
      }
    }, 3000);
  </script>
</body>
</html>
